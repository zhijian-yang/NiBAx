<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pre-Processing &mdash; NiBAχ 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Placeholder Gallery" href="../auto_examples/index.html" />
    <link rel="prev" title="User Guide" href="userguide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/NiBAx.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                main
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Pre-Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Applications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../auto_examples/index.html">Placeholder Gallery</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Developer Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NiBAχ</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Data Pre-Processing</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/CBICA/NiBAx/blob/main/docs/contents/datapreprocessing.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="data-pre-processing">
<h1>Data Pre-Processing<a class="headerlink" href="#data-pre-processing" title="Permalink to this headline"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The documentation is under active development.
Statistical and machine learning models will be made available once fully
validated.</p>
</div>
<p>## MUSE/RAVENS Pipeline
The MUSE/RAVENS pipeline performs the anatomical segmentation and parcellation.
Following these steps will setup the MUSE/RAVENS processing pipeline using a
singularity container.</p>
<p>### Setup
Running the scripts inside the container requires Git and Singularity.
Follow directions of the respective tools to install.</p>
<blockquote>
<div><p>Singularity (<a class="reference external" href="https://sylabs.io/guides/3.8/admin-guide/installation.html">https://sylabs.io/guides/3.8/admin-guide/installation.html</a>)
Git (<a class="reference external" href="https://github.com/git-guides/install-git">https://github.com/git-guides/install-git</a>)</p>
</div></blockquote>
<p>Make sure that <cite>singularity</cite> and <cite>git</cite> are available in the terminal, for instance
by adding them to the <cite>$PATH</cite> environment variable.</p>
<p>Additionally, make sure that an environment variable <cite>$TMPDIR</cite> points to a
temporary scratch space that can be used to store intermediate results.
Otherwise, it will be set to <cite>$PWD</cite> (i.e. the current working directory).</p>
<p>### Complete example</p>
<p>1. Clone the istaging git repository
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">GIT_LFS_SKIP_SMUDGE=1</span> <span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/CBICA/NiBAx/</span>
<span class="pre">cd</span> <span class="pre">NiBAx/Image_Processing/sMRI</span>
<span class="pre">git</span> <span class="pre">lfs</span> <span class="pre">pull</span> <span class="pre">--include</span> <span class="pre">example</span>
<span class="pre">git</span> <span class="pre">lfs</span> <span class="pre">pull</span> <span class="pre">--include</span> <span class="pre">sMRI_ProcessingPipeline</span>
<span class="pre">`</span></code></p>
<p>2. Download from the singularity cloud and save the .sif file in the <cite>Container/</cite> folder.
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">cd</span> <span class="pre">Container</span>
<span class="pre">singularity</span> <span class="pre">pull</span> <span class="pre">library://jimitdoshi/cbica/cbica-muse-pipeline:1.0.0</span>
<span class="pre">cd</span> <span class="pre">..</span>
<span class="pre">`</span></code></p>
<p>3. Follow the example provided in the <cite>example/</cite> directory
<code class="docutils literal notranslate"><span class="pre">`</span>
<span class="pre">bash</span> <span class="pre">example/run_example.sh</span>
<span class="pre">`</span></code></p>
<ol class="arabic" start="4">
<li><dl>
<dt>This step will create a <cite>Protocols</cite> directory inside <cite>example</cite> which contains all the results files.</dt><dd><p><a href="#id1"><span class="problematic" id="id2">``</span></a>`
# Re-orientation to LPS
example/Protocols/ReOrientedLPS/SUB-01/SUB-01_T1_LPS.nii.gz</p>
<p># Intensity inhomogeneity correction
example/Protocols/BiasCorrected/SUB-01/SUB-01_T1_LPS_N4.nii.gz</p>
<p># Brain extraction
example/Protocols/Skull-Stripped/SUB-01/SUB-01_T1_LPS_N4_brainmask_muse-ss.nii.gz
example/Protocols/Skull-Stripped/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss.nii.gz
example/Protocols/Skull-Stripped/SUB-01/SUB-01_T1_LPS_N4_ROI_1_SimRank.nii.gz</p>
<p># Another round of inhomogeneity correction using fast
example/Protocols/fastbc/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_seg.nii.gz
example/Protocols/fastbc/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc.nii.gz</p>
<p># MUSE ROI labeling
example/Protocols/MUSE/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse.nii.gz
example/Protocols/MUSE/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_DerivedVolumes.csv</p>
<p># Tissue segmentation using MUSE ROIs
example/Protocols/Segmented/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg.nii.gz</p>
<p># RAVENS
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_rTemplate_ants-0.5_JacDet.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_rTemplate_ants-0.5.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_10.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_50.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_150.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_250.nii.gz</p>
<p># Post-processed RAVENS
### Smoothed by 2mm
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_10_s2.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_50_s2.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_150_s2.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_250_s2.nii.gz
### Downsampled to 2mmx2mmx2mm
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_10_s2_DS.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_50_s2_DS.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_150_s2_DS.nii.gz
example/Protocols/RAVENS/SUB-01/SUB-01_T1_LPS_N4_brain_muse-ss_fastbc_muse_seg_ants-0.5_RAVENS_250_s2_DS.nii.gz
<a href="#id3"><span class="problematic" id="id4">``</span></a><a href="#id5"><span class="problematic" id="id6">`</span></a></p>
</dd>
</dl>
</li>
</ol>
<p>## fMRI Processing
This pipeline is for pre-processing fMRI time-series using an incrementally
modified version of the [UK_biobank_pipeline](<a class="reference external" href="https://git.fmrib.ox.ac.uk/falmagro/UK_biobank_pipeline_v_1">https://git.fmrib.ox.ac.uk/falmagro/UK_biobank_pipeline_v_1</a>).
The pipeline removes structured artifacts using ICA+FIX [[2]](#2), resamples filtered functional data to standard space, applies GIGICA[[3]](#3) on functional data to extract features. Higher level functionalities include:</p>
<blockquote>
<div><ol class="lowerroman simple">
<li><p>Generating filtered functional data and resampling to standard space(MNI152_2mm)</p></li>
<li><p>Getting subject specific IC time courses using GIGICA.</p></li>
<li><p>Getting Correlation Matrices at two different dimensionalities 25(21 useful components) and 100(55 useful)</p></li>
</ol>
</div></blockquote>
<p>### Built With</p>
<blockquote>
<div><p>Python &amp; bash (UK_biobank_pipeline)
Wrapper Scripts(bash) &amp; mostly FSL and AFNI commands as base</p>
</div></blockquote>
<p>### Packages required</p>
<p>UKBiobank pipeline (<a class="reference external" href="https://github.com/CBICA/UK_biobank_pipeline_v_1.git">https://github.com/CBICA/UK_biobank_pipeline_v_1.git</a>)</p>
<p>GIGICA - Group Information Guided ICA (<a class="reference external" href="https://www.nitrc.org/projects/gig-ica/">https://www.nitrc.org/projects/gig-ica/</a>)</p>
<p>### Outputs</p>
<p>Dimensions : n = 25 or 100 components (Group ICs from UKBiobank)
Good Components list are in : (only useful components are extracted and saved)
n25 :  <a class="reference external" href="https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_GoodComponents_d25_v1.txt">https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_GoodComponents_d25_v1.txt</a>
n100 : <a class="reference external" href="https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_GoodComponents_d100_v1.txt">https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_GoodComponents_d100_v1.txt</a></p>
<p>and can be viewed : (this includes viewing bad nodes also)</p>
<p><a class="reference external" href="https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_ICA_d25.html">https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_ICA_d25.html</a>
<a class="reference external" href="https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_ICA_d100.html">https://www.fmrib.ox.ac.uk/ukbiobank/group_means/rfMRI_ICA_d100.html</a></p>
<p>For Partial and Full Correlations saved n*(n-1)/2 vectorized elements.
i)Nodal amplitudes (21 useful/25 and 55 useful/100)
ii)Partial Correlation Matrix (vectorized and saved upper triangle 210 and 1485)
iii) Full Correlation Matrix (vectorized and saved upper triangle - 210  elements and 1485)</p>
<p>### Getting Started</p>
<p>### Download and Setup</p>
<p><strong>UKB_Pipeline:</strong></p>
<dl class="simple">
<dt><a href="#id7"><span class="problematic" id="id8">``</span></a><a href="#id9"><span class="problematic" id="id10">`</span></a>bash</dt><dd><p>GIT_LFS_SKIP_SMUDGE=1 git clone <a class="reference external" href="https://git.upd.unibe.ch/p400pm_191026/istaging_data_consolidation.git">https://git.upd.unibe.ch/p400pm_191026/istaging_data_consolidation.git</a> IDC_TEMP
cd IDC_TEMP/Image_Processing/fMRI
git lfs pull –include GIGICAR.tar.gz
git submodule update –init  UK_biobank_pipeline_v_1</p>
</dd>
</dl>
<p><a href="#id11"><span class="problematic" id="id12">``</span></a>`
Note : git submodule update –init will work with git/2.23.0 &amp; above. Otherwise use git init and then git submodule add UK_biobank_pipeline_v_1</p>
<p><strong>GIGICA:</strong></p>
<ul class="simple">
<li><p>~~wget <a class="reference external" href="https://www.nitrc.org/frs/download.php/5267/GIGICAv1.1-CentOS6.3-CMD20130207.zip~~">https://www.nitrc.org/frs/download.php/5267/GIGICAv1.1-CentOS6.3-CMD20130207.zip~~</a></p></li>
<li><p>~~unzip GIGICAv1.1-CentOS6.3-CMD20130207.zip~~</p></li>
<li><p>~~mv GIGICAv1.1-CentOS6.3-CMD20130207/ GIGICAR~~</p></li>
<li><p>~~rm -rf GIGICAv1.1-CentOS6.3-CMD20130207.zip~~</p></li>
</ul>
<p><a href="#id13"><span class="problematic" id="id14">``</span></a><a href="#id15"><span class="problematic" id="id16">`</span></a>bash</p>
<p>tar xvfz GIGICAR.tar.gz
rm -rf GIGICAR.tar.gz
<a href="#id17"><span class="problematic" id="id18">``</span></a><a href="#id19"><span class="problematic" id="id20">`</span></a></p>
<p><strong>FSLNets:</strong></p>
<p>This is for calculating networks (dependency: MATLAB and L1 precision)
For more information: <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSLNets">https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSLNets</a></p>
<p><code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1</span>
<span class="pre">wget</span> <span class="pre">http://www.fmrib.ox.ac.uk/~steve/ftp/fslnets.tar.gz</span>
<span class="pre">tar</span> <span class="pre">xvfz</span> <span class="pre">fslnets.tar.gz</span>
<span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">fslnets.tar.gz</span>
<span class="pre">`</span></code></p>
<p><strong>L1precision:</strong></p>
<p>To estimate L1-norm regularized partial correlation. Here, we are not regularizing/normalizing correlations for now. But its good to get this on path.
<code class="docutils literal notranslate"><span class="pre">`bash</span>
<span class="pre">cd</span> <span class="pre">IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/FSLNets</span>
<span class="pre">wget</span> <span class="pre">http://www.cs.ubc.ca/~schmidtm/Software/L1precision.zip</span>
<span class="pre">unzip</span> <span class="pre">L1precision.zip</span>
<span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">L1precision.zip</span>
<span class="pre">`</span></code></p>
<p>With the setup being complete, now navigate to ~/IDC_TEMP/Image_Processing/fMRI/scripts for running the pipeline.</p>
<p>### Input Data:</p>
<p>Step 1 expects data to be in partial BIDS format. And for each subject, folder structure would be for example (runs both structural and functional pipelines and generate T1 brain mask for registration) :</p>
<p>${sub}/fMRI_nosmooth/rfMRI.nii.gz
${sub}/T1/T1.nii.gz</p>
<p>### To create Input data:
<a href="#id21"><span class="problematic" id="id22">``</span></a><a href="#id23"><span class="problematic" id="id24">`</span></a></p>
<blockquote>
<div><p>sh convert_to_BIDS.sh -f ${path_to_resting_data} -s ${path_to_t1} -d ${destination} -smooth 0 # or 1</p>
</div></blockquote>
<p><a href="#id25"><span class="problematic" id="id26">``</span></a>`
This creates the corresponding directory, copies files, and reorients images to LAS.</p>
<p>### Submitting cluster job</p>
<p>This is an example of how to get the pipeline up and running locally. Assuming all wrapper scripts,UKBiobank pipeline and GIGICA are properly cloned:</p>
<p>### Step 1 Filter functional data in MNI152_2mm template space</p>
<p><strong>Result to look for :</strong> ${dest}/${sub}/fMRI_nosmooth/rfMRI.ica/reg_standard/filtered_func_data_clean.nii.gz</p>
<blockquote>
<div><p>Example command for preprocessing the data:</p>
</div></blockquote>
<dl class="simple">
<dt><a href="#id27"><span class="problematic" id="id28">``</span></a><a href="#id29"><span class="problematic" id="id30">`</span></a>bash</dt><dd><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -j y -l h_vmem=12G -o ${dest}/${sub}/sge/$JOB_NAME-$JOB_ID.log ${path_to_script}/ukbb_fix.sh -s ${sub} -i ${inpath} -tr ${TR} -te ${TE} -fwhm 100 -p ${UKBB_Pipeline_Dir} -smooth 0 );</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id31"><span class="problematic" id="id32">``</span></a><a href="#id33"><span class="problematic" id="id34">`</span></a></p>
<dl>
<dt>where sub - subject ID</dt><dd><p>inpath - Path for input directory where subject directory exists(output will be saved in ${inpath}/${sub})
TR - Repetition Time(sec)
TE - Echo Time(ms)
FWHM - Smoothing parameter - Full Width at Half Max
p - location of UKBB pipeline directory
-smooth - 0/1 0-no smoothing(uses WHII training data for FIX denoising)</p>
<blockquote>
<div><p>1 - smoothing (uses Standard data for FIX denoising)</p>
</div></blockquote>
</dd>
</dl>
<p>### Step 2:</p>
<p><strong>Running GIGICA on filtered functional data</strong></p>
<p>Run separately for 25 and 100 components.</p>
<dl class="simple">
<dt><strong>Result to look for:</strong> ${dest}/${sub}/${sub}_gigica.mat which has subject specific time courses and ICs.</dt><dd><dl class="simple">
<dt>gigica.mat - ic<span class="classifier">nVoxels x nComponents</span></dt><dd><ul class="simple">
<li><p>tc : nTimecourses x nComponents</p></li>
</ul>
</dd>
</dl>
</dd>
</dl>
<p><strong>Other results:</strong> ${sub}_timecourses.nii.gz and ${sub}_componets.nii.gz</p>
<p>Example command for obtaining gigica matrix for an individual:</p>
<dl class="simple">
<dt><a href="#id35"><span class="problematic" id="id36">``</span></a><a href="#id37"><span class="problematic" id="id38">`</span></a>bash</dt><dd><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l h_vmem=10G -o ${dest}/${sub}/sge/$JOB_NAME-$JOB_ID.log ${path_to_script}/run_GIGICA.sh -in ${filtered_img} -ref ${ref_ics} -mask ${mask_img} -dest ${out_base} -p ${gigica_dir} -a 0.5 );</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id39"><span class="problematic" id="id40">``</span></a><a href="#id41"><span class="problematic" id="id42">`</span></a></p>
<blockquote>
<div><dl class="simple">
<dt>where in - full path to filtered functional data registered to standard space from previous step (4D file)</dt><dd><p>ref - absolute path to reference group ICs(4D file)
mask -  absolute path to MNI152_2mm binarized mask
dest - output directory along with  base name
p - path to GIGICA scripts directory
a - similarity parameter by default 0.5 (optional)</p>
</dd>
</dl>
</div></blockquote>
<p>### Step 3 Extract features from GIGICA matrix</p>
<p>Run separately for 25 and 100 components.</p>
<p><strong>Result to look for:</strong> Within ${dest}/${sub}/rfMRI_d100/:</p>
<p>${sub}_NodeAmplitudes_v1.txt - which has nodal amplitudes of size n=21 or n=55
${sub}_partialcorr_v1.txt - partial correlations of size (21x20/2 = 210 elements or 55x54/2 = 1485 elements)
${sub}_fullcorr_v1.txt - Full correlations of size (21x20/2 = 210 elements or 55x54/2 = 1485 elements)</p>
<p>Example command for obtaining final features for an individual:</p>
<dl class="simple">
<dt><a href="#id43"><span class="problematic" id="id44">``</span></a><a href="#id45"><span class="problematic" id="id46">`</span></a>bash</dt><dd><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l h_vmem=8G -o ${dest}/${sub}/sge/$JOB_NAME-$JOB_ID.log ${script}/processing_gigica.sh -s ${sub} -tr ${TR} -iDir ${protoDir}/GIGICA/gigica_d100 -nets ${FSLNets} -p ${ukb} -n  ${nc} -gDir ${ukb}/templates/group/ -tp ${ntp} -o ${dest})</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id47"><span class="problematic" id="id48">``</span></a><a href="#id49"><span class="problematic" id="id50">`</span></a></p>
<dl class="simple">
<dt>where s - subject ID</dt><dd><p>tr - Repetition Time(sec)
iDir - path for GIGICA input result directory
nets - path to FSLNets. This must be within UK_biobank_pipeline_v_1 when we clone repository
p - path to UKBiobank scripts directory
n - number of components(25 or 100)
gDir - path to group directory where template for melodic_IC_d25 and melodic_IC_d100 exists.
tp - number of timepoints
o - destination directory for saving final results.</p>
</dd>
</dl>
<p>### Working Example:</p>
<ol class="lowerroman">
<li><p>Copy data from project:</p>
<blockquote>
<div><p>mkdir ${HOME}/Data/ -pv
cp -r /cbica/projects/BLSA/Pipelines/rsfMRI/rsfMRI_2020/Data/Nifti/BLSA_7996_06-0_10/ ${HOME}/Data/</p>
</div></blockquote>
</li>
<li><p>Set all environment variables and paths in settings.sh within scripts directory.</p></li>
<li><dl class="simple">
<dt>Create destination directory</dt><dd><p>mkdir ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/sge -pv</p>
</dd>
</dl>
</li>
</ol>
<dl class="simple">
<dt><a href="#id51"><span class="problematic" id="id52">``</span></a><a href="#id53"><span class="problematic" id="id54">`</span></a>bash</dt><dd><p>sh convert_to_BIDS.sh -f ${HOME}/Data/BLSA_7996_06-0_10/BLSA_7996_06-0_10_REST.nii.gz -s ${HOME}/Data/BLSA_7996_06-0_10/BLSA_7996_06-0_10_T1.nii.gz  -d ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10 -smooth 0</p>
</dd>
</dl>
<p><a href="#id55"><span class="problematic" id="id56">``</span></a><a href="#id57"><span class="problematic" id="id58">`</span></a></p>
<blockquote>
<div><dl class="simple">
<dt>Expected output is :</dt><dd><p>${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/fMRI_nosmooth/rfMRI.nii.gz
${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/T1/T1.nii.gz</p>
</dd>
</dl>
</div></blockquote>
<p>For submitting this script to cluster:
<a href="#id59"><span class="problematic" id="id60">``</span></a><a href="#id61"><span class="problematic" id="id62">`</span></a>bash</p>
<blockquote>
<div><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l short -o ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/sge/$JOB_NAME-$JOB_ID.log $HOME/IDC_TEMP/Image_Processing/fMRI/scripts/convert_to_BIDS.sh -f ${HOME}/Data/BLSA_7996_06-0_10/BLSA_7996_06-0_10_REST.nii.gz -s ${HOME}/Data/BLSA_7996_06-0_10/BLSA_7996_06-0_10_T1.nii.gz  -d ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10 -smooth 0)</p>
</dd>
</dl>
</div></blockquote>
<p><a href="#id63"><span class="problematic" id="id64">``</span></a><a href="#id65"><span class="problematic" id="id66">`</span></a></p>
<blockquote>
<div><ol class="lowerroman simple" start="4">
<li><p>Check Orientation and see if it is LAS:</p></li>
</ol>
<blockquote>
<div><p>fslhd ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/fMRI_nosmooth/rfMRI.nii.gz
fslhd ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/T1/T1.nii.gz</p>
</div></blockquote>
<dl class="simple">
<dt>Expected<span class="classifier">qform_xorient  Right-to-Left</span></dt><dd><p>qform_yorient  Posterior-to-Anterior
qform_zorient  Inferior-to-Superior</p>
</dd>
</dl>
<ol class="loweralpha simple" start="22">
<li><p>Next run fmri pipeline by:</p></li>
</ol>
</div></blockquote>
<dl class="simple">
<dt><a href="#id67"><span class="problematic" id="id68">``</span></a><a href="#id69"><span class="problematic" id="id70">`</span></a>bash</dt><dd><dl class="simple">
<dt>sh ukbb_fix.sh  </dt><dd><p>-s BLSA_7996_06-0_10 -tr 2 -te 25 -fwhm 100  -p ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/  -i ${HOME}/Out/UKB_Pipeline/ -smooth 0</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id71"><span class="problematic" id="id72">``</span></a>`
Expected: ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/fMRI_nosmooth/rfMRI.ica/reg_standard/filtered_func_data_clean.nii.gz (in standard space)</p>
<p>For submitting this script to cluster:
<a href="#id73"><span class="problematic" id="id74">``</span></a><a href="#id75"><span class="problematic" id="id76">`</span></a>bash</p>
<blockquote>
<div><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l h_vmem=12G -o ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/sge/$JOB_NAME-$JOB_ID.log $HOME/IDC_TEMP/Image_Processing/fMRI/scripts/ukbb_fix.sh -s BLSA_7996_06-0_10 -tr 2 -te 25 -fwhm 100  -p ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/  -i ${HOME}/Out/UKB_Pipeline/ -smooth 0)</p>
</dd>
</dl>
</div></blockquote>
<p><a href="#id77"><span class="problematic" id="id78">``</span></a><a href="#id79"><span class="problematic" id="id80">`</span></a></p>
<p>vi) For GIGICA,
mkdir ${HOME}/Out/GIGICA/gigica_d100/BLSA_7996_06-0_10/sge -pv</p>
<p><a href="#id81"><span class="problematic" id="id82">``</span></a><a href="#id83"><span class="problematic" id="id84">`</span></a>bash
sh run_GIGICA.sh </p>
<blockquote>
<div><p>-in ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/fMRI_nosmooth/rfMRI.ica/reg_standard/filtered_func_data_clean.nii.gz -ref ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/templates/group/melodic_IC_100.nii.gz  -mask ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/templates/MNI152_T1_2mm_brain_mask_bin.nii.gz -dest ${HOME}/Out/GIGICA/gigica_d100/BLSA_7996_06-0_10/BLSA_7996_06-0_10 -p ${HOME}/GIGICAR/ -a 0.5</p>
</div></blockquote>
<p><a href="#id85"><span class="problematic" id="id86">``</span></a><a href="#id87"><span class="problematic" id="id88">`</span></a></p>
<p>Pre-requisite: This script takes filtered_func_data_clean in standard space as input which is the output from previous step.
Expected:  ${HOME}/Out/GIGICA/gigica_d100/BLSA_7996_06-0_10/BLSA_7996_06-0_10_gigica.mat</p>
<p>The above script runs on MATLAB and exceeds interactive CPU/run limit. It may also use lot of CPUs. To avoid this, it can be submitted as batch job as below .</p>
<dl class="simple">
<dt><a href="#id89"><span class="problematic" id="id90">``</span></a><a href="#id91"><span class="problematic" id="id92">`</span></a>bash</dt><dd><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l h_vmem=10G -o ${HOME}/Out/GIGICA/gigica_d100/BLSA_7996_06-0_10/sge/$JOB_NAME-$JOB_ID.log $HOME/IDC_TEMP/Image_Processing/fMRI/scripts/run_GIGICA.sh -in ${HOME}/Out/UKB_Pipeline/BLSA_7996_06-0_10/fMRI_nosmooth/rfMRI.ica/reg_standard/filtered_func_data_clean.nii.gz -ref ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/templates/group/melodic_IC_100.nii.gz  -mask ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/templates/MNI152_T1_2mm_brain_mask_bin.nii.gz -dest ${HOME}/Out/GIGICA/gigica_d100/BLSA_7996_06-0_10/BLSA_7996_06-0_10 -p ${HOME}/IDC_TEMP/Image_Processing/fMRI/GIGICAR/ -a 0.5 )</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id93"><span class="problematic" id="id94">``</span></a><a href="#id95"><span class="problematic" id="id96">`</span></a></p>
<p>vii) For Feature Extraction,
mkdir
${HOME}/Out/Features/BLSA_7996_06-0_10/sge -pv</p>
<dl class="simple">
<dt><a href="#id97"><span class="problematic" id="id98">``</span></a><a href="#id99"><span class="problematic" id="id100">`</span></a>bash</dt><dd><dl class="simple">
<dt>sh processing_gigica.sh </dt><dd><p>-s BLSA_7996_06-0_10 -tr 2 -iDir ${HOME}/Out/GIGICA/gigica_d100/ -nets ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/FSLNets -p ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/ -n 100 -gDir ${HOME}/IDC_TEMP/Representation/fMRI/UK_biobank_pipeline_v_1/templates/group/ -tp 180 -o ${HOME}/Out/Features/</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id101"><span class="problematic" id="id102">``</span></a><a href="#id103"><span class="problematic" id="id104">`</span></a></p>
<p>Expected:
${HOME}/Out/Features/BLSA_7996_06-0_10/rfMRI_d100/BLSA_7996_06-0_10_NodeAmplitudes_v1.txt
${HOME}/Out/Features/BLSA_7996_06-0_10/rfMRI_d100/BLSA_7996_06-0_10_partialcorr_v1.txt
${HOME}/Out/Features/BLSA_7996_06-0_10/rfMRI_d100/BLSA_7996_06-0_10_fullcorr_v1.txt</p>
<p>For submitting this script to cluster:</p>
<dl class="simple">
<dt><a href="#id105"><span class="problematic" id="id106">``</span></a><a href="#id107"><span class="problematic" id="id108">`</span></a>bash</dt><dd><dl class="simple">
<dt>jid=$(qsub </dt><dd><p>-terse -b y -j y -l h_vmem=8G -o ${HOME}/Out/Features/BLSA_7996_06-0_10/sge/$JOB_NAME-$JOB_ID.log $HOME/IDC_TEMP/Image_Processing/fMRI/scripts/processing_gigica.sh -s BLSA_7996_06-0_10 -tr 2 -iDir ${HOME}/Out/GIGICA/gigica_d100/ -nets ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/FSLNets -p ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/ -n 100 -gDir ${HOME}/IDC_TEMP/Image_Processing/fMRI/UK_biobank_pipeline_v_1/templates/group/ -tp 180 -o ${HOME}/Out/Features/ )</p>
</dd>
</dl>
</dd>
</dl>
<p><a href="#id109"><span class="problematic" id="id110">``</span></a><a href="#id111"><span class="problematic" id="id112">`</span></a></p>
<p>## References
&lt;a id=”1”&gt;[1]&lt;/a&gt; Miller KL, Alfaro-Almagro F, Bangerter NK, Thomas DL, Yacoub E, Xu J, Bartsch AJ, Jbabdi S, Sotiropoulos SN, Andersson JL, Griffanti L, Douaud G, Okell TW, Weale P, Dragonu I, Garratt S, Hudson S, Collins R, Jenkinson M, Matthews PM, Smith SM. Multimodal population brain imaging in the UK Biobank prospective epidemiological study. Nat Neurosci. 2016 Nov;19(11):1523-1536. doi: 10.1038/nn.4393 . Epub 2016 Sep 19. PMID: 27643430 ; PMCID: PMC5086094.</p>
<p>&lt;a id=”2”&gt;[2]&lt;/a&gt; L. Griffanti, G. Salimi-Khorshidi, C.F. Beckmann, E.J. Auerbach, G. Douaud, C.E. Sexton, E. Zsoldos, K. Ebmeier, N. Filippini, C.E. Mackay, S. Moeller, J.G. Xu, E. Yacoub, G. Baselli, K. Ugurbil, K.L. Miller, and S.M. Smith. ICA-based artefact removal and accelerated fMRI acquisition for improved resting state network imaging. NeuroImage, 95:232-47, 2014</p>
<p>&lt;a id=”3”&gt;[3]&lt;/a&gt; Du Y, Fan Y. Group information guided ICA for fMRI data analysis. Neuroimage. 2013 Apr 1;69:157-97. doi: 10.1016/j.neuroimage.2012.11.008 . Epub 2012 Nov 27. PMID: 23194820 .</p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="userguide.html" class="btn btn-neutral float-left" title="User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../auto_examples/index.html" class="btn btn-neutral float-right" title="Placeholder Gallery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, CBICA, University of Pennsylvania.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: main
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
        
           <strong> 
          <dd><a href="/NiBAx/en/main/">en</a></dd>
           </strong> 
        
          
          <dd><a href="/NiBAx/es/main/">es</a></dd>
          
        
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
           <strong> 
          <dd><a href="/NiBAx/en/main/">main</a></dd>
           </strong> 
        
      </dl>
      
      
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="/NiBAx/en/main/NiBAχ-docs_en_main.pdf">pdf</a></dd>
        
          <dd><a href="/NiBAx/en/main/NiBAχ-docs_en_main.epub">epub</a></dd>
        
      </dl>
      
      
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.
 
    </div>
  </div>

 <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #95b1c2;
    }
    /* Sidebar */
    .wy-nav-side {
      background: #363745;
    }
  </style>


</body>
</html>